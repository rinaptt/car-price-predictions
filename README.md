# Домашнее задание № 1. Отчёт

## Задачи

- провести разведочный анализ данных (EDA)
- обучить модели для предсказания стоимости автомобилей
- сохранить лучшую модель/пайплайн в pickle-файле и создать Streamlit-приложение, в котором можно будет спрогнозировать цены на новые автомобили и посмотреть на основные визуализации, сделанные в ходе EDA

## Данные

В тренировочном наборе данных 6 999 строк, в тестовом — 1000. Названия 13-ти признаков и исходные типы данных представлены в таблице ниже.

| Столбец                                     | Тип данных |
| ------------------------------------------  | ---------- |
| name, модель                                | object     |
| year, год выпуска                           | int64      |
| **selling_price, цена (целевая переменная)**| **int64**  |
| km_driven, пробег                           | int64      |
| fuel, тип топлива                           | object     |
| seller_type, продавец                       | object     |
| transmission, тип коробки передач           | object     |
| owner, предыдущие владельцы                 | object     |
| mileage, топливная экономичность двигателя  | object     |
| engine, объём двигателя                     | object     |
| max_power, максимальная мощность двигателя  | object     |
| torque, крутящий момент двигателя           | object     |
| seats, количество мест в автомобиле         | float64    |
 
## Дашборды

Построены **дашборды** с помощью библиотеки `ydata-profilling`.

Наблюдается высокая корреляция между целевой переменной `selling_price` и признаками `year`, `transmission`.

В категориальных столбцах уникальные значения распределены неравномерно.
- в столбце `fuel` четыре вида **топлива**: _Diesel_ (дизельное), _Petrol_ (бензиновое), _LPG_ (сжиженный нефтяной газ) и _CNG_ (сжатый природный газ), причём первые два вида топлива сильно преобладают
- в столбце `seller_type` есть три типа **продавцов**: _Individual_ (частное лицо), _Dealer_ (дилер), _Trustmark Dealer_ (видимо, к этой категории относятся более надёждые и проверенные дилеры); категория _Individual_ самая многочисленная
- столбец `transmission` (тип **коробки передач**) содержит две категории: _Manual_ (механическая) и _Automatic_ (автоматическая), подавляющее большинство автомобилей имеют механическую коробку передач
- в столбце `owner` содержится информация о количестве предыдущих владельцев автомобиля: _First Owner_ (один), _Second Owner_ (два), _Third Owner_ (три), _Fourth & Above Owner_ (четыре и более), _Test Drive Car_ (автомобиль после тест-драйва); автомобили, у которых был один владелец, преобладают

 ## Дубликаты и пропуски

В тренировочном датасете выявлено **985** явных дубликатов, а в тестовом — **62**.
**Повторяющиеся строки**, содержащие одинаковые значения во всех столбцах, кроме столбца с целевой переменной (`selling_price`), обнаружены в обоих наборах данных, а удалены только _из тренировочного_. Скорее всего, эти дубликаты обусловлены ошибкой ввода данных. Всего было удалено **1 159** строк, первые вхождения каждого дубликата сохранены.

**Пропущенные значения** обнаружены в тренировочном и тестовом датасетах в пяти столбцах `mileage`, `engine`, `max_power`, `torque` и `seats`. В столбцах  `mileage`, `engine` и `seats` **202** пропущенных значения, в `torque` — **203**, а в `max_power` — **196**. В тестовом наборе данных по **19** пропусков в каждом из перечисленных столбцов.

Столбцы `mileage`, `engine` и `max_power` изначально имели тип данных `object` и содержали не только числа, но и единицы измерения. В этих столбцах оставлены только числовые значения, а **тип данных** преобразован к `float32`. Типы данных в столбцах `engine` и `seats` (`float64`) приведены к целочисленным типам `int16` и `int8`, соответственно.

По тренировочному набору данных для столбцов `mileage`, `engine`, `max_power` и `seats` вычислены **медианные** значения. Ими **заполнены пропуски** в тренировочном и в тестовом датасетах.

В тренировочном датасете в столбцах `mileage` (топливная экономичность двигателя: сколько км может проехать автомобиль, израсходовав 1 л топлива) и `max_power` (максимальная мощность двигателя) обнаружены **нулевые значения**, которые не имеют физического смысла. Таких строк в тренировочном датасете _немного_ (17), а в тестовом только одно. Эти нулевые значения были рассмотрены как пропуски и заменены медианами по соответствующим столбцам.

Столбец `torque` был удалён.

## Статистики

- числовые признаки имеют разный масштаб
- в обоих датасетах у признаков `selling_price`, `km_driven`, `engine`, `max_power`, `seats` средние значения несколько больше медианных; среднее более чувствительно к наличию экстремально больших значений; минимальное и максимальное значения в столбцах `selling_price` и	`km_driven` различаются на несколько порядков
- средняя и медианная цены на автомобили выше в тестовом наборе данных (среднее: 617 901,0; медиана: 434 999,0), чем в тренировочном (среднее: 522 960,1; медиана: 405 000,0)
- в тренировочном наборе данных более широкий диапазон годов производства автомобилей (1983-2020), чем в тестовом (1995-2020)
- количество категорий в категориальных столбцах одинаковое и в тренировочном, и в тестовом датасетах; самые представленные категории совпадают для признаков `fuel` — _Diesel_, `seller_type` — _Individual_, `transmission` — _Manual_, `owner` — _First Owner_; по встречаемости в столбце `name` лидируют автомобили марки _Maruti_
- в столбце `name` много уникальных значений (1924 в тренировочном датасете и 621 в тестовом)

## Взаимосвязь между переменными

С помощью `pairplot` проанализированы взаимосвязи между количественными переменными, а также распределения отдельных переменных:
- прослеживалась  **линейная** взаимосвязь между целевой переменной (`selling_price`) и признаком `max_power`, а также **нелинейная** связь `selling_price` с признаком `year`
- можно предположить наличие линейной связи между переменными `max_power` - `engine`, `mileage` - `engine`, `mileage` - `max_power`
- при рассмотрении диаграмм рассеяния отмечены различия между тренировочной и тестовой выборками в разбросе данных: например, на диаграммах рассеяния для тренировочной выборки у переменной `km_driven` видны большие значения, сильно удалённые от основного скопления точек
- распределения некоторых переменных **скошенные**: влево для `year` и вправо для `selling_price` и `km_driven`

На основе таблицы корреляции с коэффициентами Пирсона построена тепловая карта. Наиболее сильная **положительная** линейная корреляция наблюдалась между признаками `max_power` - `selling_price` (**0,69**), `engine` - `max_power` (**0,68**) и `engine` - `seats` (**0,65**), т.е. при увеличении одной переменной другая переменная в среднем также увеличивается.

Построены дополнительные визуализации — боксплоты. Медианная цена самая высокая у автомобилей на дизельном топливе, а самая низкая — на _LPG_; цены у автомобилей на топливе _LPG_ наименее вариативны. У автомобилей с типом топлива _Diesel_ и _Petrol_ большой разброс цен в верхней части данных, причём у одного автомобиля на бензиновом топливе очень высокая цена, по сравнению с остальными — 10 000 000. В датасете нет автомобилей на топливе _LPG_, выпущенных после 2015 года. Автомобили с бензиновыми и дизельными двигателями представлены в широком диапазоне годов выпуска.

## Обучение и сравнение моделей

В данной работе были обучены классическая линейная регресия, Lasso-, Ridge- и ElasticNet-регрессия.

Качество моделей оценивалось по **метрикам** $R^2$ и $MSE$. Идеальное значение для $R^2$ равно 1. Чем меньше $MSE$, тем лучше качество модели. Значения $MSE$ получились очень большими из-за того, в этой задаче предсказываются цены на автомобили, диапазон которых очень широк, и разница между исходным и предсказанным значениями возводится в квадрат.

Для подбора **гиперпараметров** по сетке использовалась 10-фолдовая кросс-валидация на тренировочном датасете. Выбор лучшей модели при кросс-валидации основывался на значении $R^2$, усреднённом по валидационным фолдам.

Перед подбором гиперпараметров для моделей из пункта 6, к числовым признакам `year`, `km_driven`, `mileage`, `engine` и `max_power` добавлено пять категориальных признаков `fuel`, `seller_type`, `transmission`, `owner`, `name` и немасштабированный столбец `seats`.

В столбце `name` тексты приведены к нижнему регистру, автомобильные марки извлечены. Всего в тренировоном датасете оказалось 30 уникальных марок автомобилей, преобладали автомобили индийской марки _Maruti_. Выявлены **малопредставленные** марки, встречающиеся 8 и менее раз. 

Все категориальные признаки (вместе с `seats`) были **закодированы методом OneHot**. Чтобы не создавать отдельные столбцы для тех значений признаков, которые встречаются весьма редко (< 10 раз - от общего количества объектов такие категории будут составлять меньше 0,2 %), в `OneHotEncoder` добавлен параметр `min_frequency=10` для группировки редких значений в одну категорию. После такого преобразования датафрейм стал содержать 40 признаков.

#### Модели

1. Линейная регрессия `lin_reg` с дефолтными параметрами на 6-ти числовых признаках (`year`, `km_driven`, `mileage`, `engine`, `max_power`, `seats`)

У метрики $R^2$ были не очень высокие, но близкие значения на тренировочном и тестовом датасетах: ~ 0,594 и ~ 0,595. $MSE$ на тестовом датасете была выше (233 120 375 098,39), чем на тренировочном (116 410 333 725,67). В общем, полученная модель плохо предсказывает целевую переменную.

2. Линейная регрессия `lin_reg_1 (scaled)` с дефолтными параметрами на 6-ти числовых признаках,  **масштабированных** с помощью `StandardScaler` 

После стандартизации значения метрик практически не изменились (разница лишь в последних цифрах после десятичной точки).

Стандартизация не улучшила качество модели, но зато позволила интерпретировать важность признаков. Наиболее важным оказался признак `max_power` (326 181,38), у которого была выявлена самая сильная положительная линейная корреляция с целевой переменной.

3. Lasso-регрессия `lasso (scaled)` с дефолтными параметрами на 6-ти числовых масштабированных признаках

Метрики качества практически не изменились. Зануления весов при использовании L1-регуляризации не произошло.

4. Lasso-регрессия `lasso_1 (scaled, alpha: 1000)` на 6-ти масштабированных числовых признаках с подобранным гиперпараметром `alpha`

Лучший коэффициент регуляризации `alpha` оказался равен 1000. Однако улучшений по метрикам на тренировочном и тестовом наборах данных не наблюдалось. $R^2$ на трейне: ~ 0.594, $MSE$ на трейне: 116 420 140 264,26. $R^2$ на тесте: ~ 0,593, $MSE$ на тесте: ~ 233 787 387 238,53. Качество у этой модели хуже, чем у классической линейной регрессии: значение $MSE$ выросло, а $R^2$ понизилось.

5. ElasticNet-регрессия `elasticnet (scaled, alpha: 0.1, l1_ratio: 0.5)` на 6-ти масштабированных числовых признаках с подобранными гиперпараметрами `alpha` и `l1_ratio`

Значения подобранных гиперпараметров:
- `alpha = 0,1` (коэффициент регуляризации)
- `l1_ratio = 0,5` (соотношение между L1- и L2-регуляризацией; если 0, то только L2-регуляризация; если 1, то L1; иначе - комбинация L1 и L2)

Метрики ухудшились и на тренировочном, и на тестовом наборах данных.

6. Ridge-регрессия `ridge (scaled + cat. features, alpha: 1e-05)` на 5-ти масштабированных числовых признаках + 6-ти категориальных (включая `seats`), закодированных методом OneHot, с подобранным гиперпараметром `alpha`

Оптимальное значение гиперпараметра `alpha`: 1e-05.

Метрика $R^2$ увеличилась, а $MSE$ уменьшилась и на тренировочном, и на тестовом наборах данных. На тренировочном наборе метрика получилась немного выше, но значения всё равно довольно близкие (~ 0,75 и ~ 0,74).

#### Сравнение моделей по бизнес-метрике

Было предложено рассчитать `business_metric` — долю прогнозов, отличающихся от реальных цен на автомобили не более, чем на 10% (в одну или другую сторону).

Значения бизнес-метрики оказались довольно низкими (не превышали 0,3) для всех моделей. Лучший результат получился у модели Ridge-регрессии (0,297).


#### Таблица со сравнением метрик качества для полученных моделей

|    | model                                          |   r2_train |   r2_test |   mse_train |    mse_test |   business_metric |
|---:|:-----------------------------------------------|-----------:|----------:|------------:|------------:|------------------:|
|  1 | lin_reg                                        |       0,59 |      0,59 | 1.1641e+11  | 2.3312e+11  |              0,23 |
|  2 | lin_reg_1 (scaled)                             |       0,59 |      0,59 | 1.1641e+11  | 2.3312e+11  |              0,23 |
|  3 | lasso (scaled)                                 |       0,59 |      0,59 | 1.1641e+11  | 2.33121e+11 |              0,23 |
|  4 | lasso_1 (scaled, alpha: 1000)                  |       0,59 |      0,59 | 1.1642e+11  | 2.33787e+11 |              0,23 |
|  5 | elasticnet (scaled, alpha: 0.1, l1_ratio: 0.5) |       0,59 |      0,58 | 1.16748e+11 | 2.39408e+11 |              0,24 |
|  6 | ridge (scaled + cat. features, alpha: 1e-05)   |       0,75 |      0,74 | 7.03602e+10 | 1.49226e+11 |              0,30 |

Таким образом, масштабирование признаков для классической линейной регрессии, а также использование Lasso- и Ridge-регрессии не помогло улучшить качество модели. 
Добавление закодированных категориальных признаков позволило **повысить метрики качества**.

По $R^2$, $MSE$ и по бизнес-метрике **Ridge-регрессия**, обученная на масштабированных числовых признаках и категориальных признаках, закодированных с помощью OneHot метода, оказалась **лучшей моделью**.

## Создание пайплайна для обработки данных и обучения модели

Для удобства этапы обработки числовых и категориальных признаков, а также обучение модели Ridge-регрессии с подобранными гиперпараметрами объединены в одном пайплайне.

На основе функций, написанных для извлечения марки автомобиля из столбца `name`, преобразования типов данных и удаления единиц измерения из столбцов `mileage`, `engine` и `max_power`, были созданы кастомные трансформеры. Предусмотрено наличие `NaN`-значений в тех столбцах, с которыми всё было в порядке в тренировочном датасете: для категориальных признаков пропуски будут заполняться строкой `NA` (неизвестная категория), а для числовых — медианой. Если в столбцах `mileage`, `engine` и `max_power` сразу будет содержаться только числа (без единиц измерения), то ошибки не возникнет, столбцы будут оставлены в исходном состоянии. Если в  загруженном файле будут содержаться столбцы, отсутствующие в тренировочном датасете, то они будут удалены при обработке признаков.

Пайплайн сохранён в pickle-файл.

## Streamlit-приложение

В приложении есть **две вкладки**. Во вкладке **"EDA и коэффициенты модели"** представлены первые пять строк тренировочного датасета, описание признаков, показаны основные графики и диаграммы, полученные в ходе EDA, а также построена гистограмма распределения весов модели.
В первой вкладке выведены диаграммы рассеяния для пар признаков  `max_power` - `selling_price`, `max_power` - `engine`, `max_power` - `mileage`, `mileage` - `engine`, гистограмма распределения целевой переменной (с медианой и средним), распределение цен автомобилей в зависимости от типа топлива. 

Во вкладке **"Применение модели"** пользователь может выбрать один из двух способов ввода данных: загрузить файл или ввести данные в нужные поля.

При загрузке файла есть возможность выбрать тип разделителя в CSV файле (запятая (по умолчанию) / точка с запятой / двоеточие / табуляция / вертикальная черта). После загрузки файла проверяется наличие ошибок, связанных с невозможностью чтения файла / отсутствием необходимых столбцов / обработкой загруженных данных.

Для ввода данных в поля установлены ограничения на значения в числовых столбцах (все не могут быть меньше единицы), чтобы пользователь не ввёл отрицательные значения. Форму не получится отправить, если не заполнить поле с моделью автомобиля.

## Выявленные проблемы и возможные улучшения

При тестировании модели на новых данных была выявлена проблема: модель может выдавать **отрицательные** значения. В тренировочном датасете большой разброс цен: минимальная равна 29 999, а максимальная — 10 000 000. Отрицательные значения обычно предсказываются для объектов, у которых реальная цена относительно небольшая (~ на уровне 100 тысяч и менее). Распределение цен автомобилей несимметричное, скошенное вправо. Возможно, в этом случае поможет логарифмирование целевой переменной с последующим обратным преобразованием.

Следует поработать над обработкой признака `name` с моделями автомобилей. Например, можно использовать `TfidfVectorizer`, чтобы получить различные слова / словосочетания из всех текстов столбца `name` и выбрать из них наиболее важные по показателю Tf-idf.

При анализе попарных распределений переменных по `pairplot` было сделано предположение о наличии нелинейной связи между целевой переменной и годом выпуска автомобиля. Можно рассмотреть создание новых признаков.

Также в данных было отмечено наличие экстремальных значений (например, в столбцах `km_driven`, `selling_price`). Можно попробовать удалить объекты с сильно отклоняющимся значениями и проверить, как их отсутствие отразится на метриках качества.
